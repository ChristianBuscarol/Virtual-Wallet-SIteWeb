<template>
  <body>
    <div v-show="modalVisibility" ref="modalRendering" class="ModalRendering">
      <div ref="modalContent" class="ModalContent" @click.stop>
        <div class="ModalTransactionModification" v-if="userTransaction.transactionInfoLevel == 1 || userTransaction.transactionInfoLevel == 3">
          <div v-if="userTransaction.transactionInfoLevel == 1" class="PurchaseTransactionInfo">
            <h3>Selected Transaction:</h3>
            <h4>Action: <strong>'Purchase'</strong></h4>
            <h4>Coin purchased: {{ this.transactionInfoLevel.crypto_code }}</h4>
            <h4>Amount: {{ this.transactionInfoLevel.crypto_amount }}</h4>
            <h4>Money spent: {{ this.transactionInfoLevel.transactionMoney }}</h4>
            <h4>DateTime: {{ this.transactionInfoLevel.datetime }}</h4>
          </div>
          
          <div v-if="userTransaction.transactionInfoLevel == 3" class="SaleTransactionInfo">
            <h3>Selected Transaction:</h3>
            <h4>Action: <strong>'Sale'</strong></h4>
            <h4>Coin sold: {{ this.transactionInfoLevel.crypto_code }}</h4>
            <h4>Amount: {{ this.transactionInfoLevel.crypto_amount }}</h4>
            <h4>Money earned: {{ this.transactionInfoLevel.transactionMoney }}</h4>
            <h4>DateTime: {{ this.transactionInfoLevel.datetime }}</h4>
          </div>

          <div class="ModificationOptionsBox">
            <h3>Modification options...</h3>

            <select v-model="transactionModification.action">
              <option value="purchase" selected>Purchase</option>
              <option value="sale">Sell</option>
            </select>

            <label for="coinSelection">Choose the 'Coin': 
              <select name="coinSelection" v-model="transactionModification.crypto_code">
                <option value="Bitcoin">Bitcoin</option>
                <option value="Dogecoin">Dogecoin</option>
                <option value="Ethereum">Ethereum</option>
                <option value="Litecoin">Litecoin</option>
                <option value="Solana">Solana</option>
                <option value="USDC">USDC</option>
              </select>
            </label>
          </div>

          <label for="coinPartSelection">Coin amount: <input type="number" v-model="transactionModification.crypto_amount" min="0.00001" name="coinPartSelection" class="coinPortionModification" placeholder="Put the coin part here to mod..."></label>

          <label>Date: <input type="date" v-model="dateSelected" class="dateModification" placeholder="Put the date here to mod..."></label>

          <label>Time: <input type="time" v-model="timeSelected" class="timeModification" placeholder="Put the time here to mod..."></label>

          <div class="ModificationButtonsBox">
            <button type="button" @click="modificationOfTransactionSelected()" class="btnModificationAccepted">Yes</button>
            <button type="button" @click="closeModalTransaction()" class="btnModificationDenied">No</button>
          </div>
        </div>

        <div class="ModalPurchaseTransactionElimination" v-if="userTransaction.transactionInfoLevel == 2">
          <h3>¿Are you sure you want to delete this purchase?</h3>
          <button type="button" @click="delteOfTransactionSelected()" v-show="!interactionOfPurchaseTransactionDelete" :disabled="interactionOfPurchaseTransactionDelete" class="btnDeleteAccepted">Yes</button>
          <button type="button" @click="closeModalTransaction()" v-show="!interactionOfPurchaseTransactionDelete" :disabled="interactionOfPurchaseTransactionDelete" class="btnDeleteDenied">No</button>
          <h3 v-if="this.moneyCalculationForDelete < 0">The 'Deletion' of the selected transaction is't ready to be made for insufficient money.</h3>
          <button type="button" @click="closeModalTransaction()" v-show="interactionOfPurchaseTransactionDelete" :disabled="!interactionOfPurchaseTransactionDelete" class="btnCloseModal">CLose.</button>
        </div>

        <div class="ModalSaleTransactionElimination" v-if="userTransaction.transactionInfoLevel == 4">
          <h3>¿Are you sure you want to delete this sale?</h3>
          <button type="button" @click="delteOfTransactionSelected()" v-show="!interactionOfSaleTransactionDelete" :disabled="interactionOfSaleTransactionDelete" class="btnEliminationConfirmation">Yes</button>
          <button type="button" @click="closeModalTransaction()" v-show="!interactionOfSaleTransactionDelete" :disabled="interactionOfSaleTransactionDelete" class="btnEliminationNegation">No</button>
          <h3 v-if="this.userTransaction.crypto_amount >= this.userTransaction.cryptoAmountAvailable">The 'Deletion' of the selected transaction is't ready to be made for insufficient coin part.</h3>
          <button type="button" @click="closeModalTransaction()" v-show="interactionOfSaleTransactionDelete" :disabled="!interactionOfSaleTransactionDelete" class="btnCloseModal">CLose.</button>
        </div>
      </div>
    </div>
  </body>
</template>

<script>
  import ApiCallService from '@/services/ApiCallService';

  export default{
    name: 'ModalTransactionModification',
    props: {
      receivedTransactionInfo: {
        type: Object,
        default: null
      }
    },
    data(){
      return{
        modalVisibility: false,
        interactionOfPurchaseTransactionDelete: false,
        interactionOfSaleTransactionDelete: false,
        moneyCalculationForDelete: 0,
        dateSelected: '',
        timeSelected: '',
        userTransaction: {
          transactionInfoLevel: 0,
          id: '',
          action: '',
          crypto_code: '',
          crypto_amount: 0,
          cryptoAmountAvailable: 0,
          money: 0,
          transactionMoney: 0,
          datetime: 0
        },
        urlCoins: [
          'https://criptoya.com/api/satoshitango/btc/ars',
          'https://criptoya.com/api/satoshitango/doge/ars',
          'https://criptoya.com/api/satoshitango/eth/ars',
          'https://criptoya.com/api/satoshitango/ltc/ars',
          'https://criptoya.com/api/satoshitango/sol/ars',
          'https://criptoya.com/api/satoshitango/usdc/ars'
        ],
        transactionModification: {
          id: '',
          action: '',
          crypto_code: '',
          crypto_amount: 0,
          money: 0,
          datetime: 0
        }
      }
    },
    methods: {
      unitTransactionInfoReceived(newVal){
        this.userTransaction.transactionInfoLevel = newVal.transactionInfoLevel;
        this.userTransaction.id = newVal.id;
        this.userTransaction.action = newVal.action;
        this.userTransaction.crypto_code = newVal.crypto_code;
        this.userTransaction.crypto_amount = newVal.crypto_amount;
        this.userTransaction.cryptoAmountAvailable = newVal.cryptoAmountAvailable;
        this.userTransaction.money = newVal.money;
        this.userTransaction.transactionMoney = newVal.transactionMoney;
        this.userTransaction.datetime = newVal.datetime;

        console.log('El objeto del Modal para la modificación o elimnación de la transacción seleccionada contiene la sieguiente info: ');
        console.log(this.userTransaction);
        this.showModalTransaction();
        this.evaluateTypeTransactionDeletion();
      },
      showModalTransaction(){
        this.modalVisibility = true;

        if(this.$refs.modalRendering && this.$refs.modalContent){
          this.$nextTick(() => {
            this.$refs.modalRendering.classList.add('show');
            this.$refs.modalContent.classList.add('show');
          });
        }
      },
      closeModalTransaction(){
        if(this.$refs.modalContent){
          this.$refs.modalContent.classList.remove('show');
        }

        setTimeout(() => {
          if(this.$refs.modalRendering){
            this.$refs.modalRendering.classList.remove('show');
          }
          this.modalVisibility = false;
          this.$emit('close');
        },500);

        this.refreshTheView('refresh-the-view');
      },
      evaluateTypeTransactionDeletion(){
        if (this.userTransaction.transactionInfoLevel == 2){
          this.confirmationOfPurchaseTransactionDelete();
        }
        else if (this.userTransaction.transactionInfoLevel == 4){
          this.confirmationOfSaleTransactionDelete();
        }
      },
      confirmationOfPurchaseTransactionDelete(){
        if (this.userTransaction.crypto_amount >= this.userTransaction.cryptoAmountAvailable){
          this.interactionOfPurchaseTransactionDelete = true;
        }
      },
      confirmationOfSaleTransactionDelete(){
        this.moneyCalculationForDelete += parseFloat(this.userTransaction.money - this.userTransaction.transactionMoney);

        if (this.moneyCalculationForDelete < 0){
          this.interactionOfSaleTransactionDelete = true;
        }
      },
      delteOfTransactionSelected(){
        ApiCallService.deleteSelectedTransaction(this.userTransaction.id);

        this.cancelOfPurchaseTransactionDelete();
        this.cancelOfSaleTransactionDelete();
      },
      cancelOfPurchaseTransactionDelete(){
        this.interactionOfPurchaseTransactionDelete = false;
      },
      cancelOfSaleTransactionDelete(){
        this.interactionOfSaleTransactionDelete = false;
      },
      modificationOfTransactionSelected(){
        this.objectConstructorForTransactionMod();
        console.log('El objeto que se prepara para la modificación de la transacción es el siguiente:');
        console.log(this.transactionModification);
      },
      objectConstructorForTransactionMod(){
        this.transactionModification.id = this.userTransaction.id;
        this.prepareDateTimeSelectedForTransactionMod();
      },
      prepareDateTimeSelectedForTransactionMod(){
        let wololoDateTime = (this.dateSelected + ' ' + this.timeSelected);

        if (this.dateSelected > 0 && this.timeSelected > 0){
          this.transactionModification.datetime = wololoDateTime;
        }
        else {
          this.transactionModification.datetime = this.userTransaction.datetime;
        }
      },
      refreshTheView(){
        this.$emit('refresh-the-view');
      }
    },
    watch: {
      receivedTransactionInfo: {
        handler(newVal) {
          if(newVal && Object.keys(newVal).length > 0){
            this.unitTransactionInfoReceived(newVal);
          }
        },
        inmediate: true
      }
    }
  }
</script>

<style scoped>
  .ModalRendering {
    display: flex;
    justify-content: center;
    align-items: center;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6); /* Fondo oscuro */
    opacity: 0; /* Comienza oculto */
    visibility: hidden; /* No visible */
    transition: opacity 1s ease-in-out, visibility 1s ease-in-out;
  }

  .ModalRendering.show {
    opacity: 1; /* Se hace visible */
    visibility: visible;
  }

  .ModalContent {
    background-color: #fff;
    width: 40%;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    transform: scale(0.8); /* Comienza más pequeño */
    transition: transform 1s ease-in-out; /* Animación de expansión */
  }

  .ModalContent.show {
    transform: scale(1); /* Expande a su tamaño normal */
  }

  .btnCloseModal {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
  }
</style>